# High Availability & Scalability: ELB & ASG

- scalability means that an application/system can handle greater loads by adapting
- scalability is related but different to High Availbility
- 2 kinds
  - vertical scalability
    - increasing the size of the instance
      - t2.micro => t2.large
    - common for non-distributed systems
      - RSD/Elasticache
    - hardware limit for scalability
  - horizontal scalability (=elastic)
    - increasing the amount of instances/systems
      - 1 t2.micro => 5 t2.micro
    - implies distributed systems
      - web/modern applications
- high availability
  - run application/system in at least 2 data centers (AZ)
  - goal is to survive a data center loss
  - hand in hand with horizontal scalability
  - passive
    - RDS Multi AZ
  - active
    - horizontal scaling

## Elastic Load Balancer (ELB)

- Load Balancers are servers that forward traffic to multiple servers downstreams
- spread across multiple downstream isntances
- expose a single point of access (DNS) to your application
- seamlessly handles failures of downstream instances
- regular health checks to your instances
- provide SSL termination (HTTPS) for your websites
- enforce stickiness with cookies
- high availability across zones
- separate public traffic from private traffic
- ELB is a managed load balancer
  - aws guarantees that it will be working
  - takes care of upgrades, maintainance, high availability
  - provides a few config knobs
  - costs lest to make your own load balancer, but doesnt really outweight the benefit
  - integrated with many AWS offerings/services
- Health Checks
  - crucial for load balancers
  - enable the load balancer to know if the instance it forwards traffice to are available to reply to requests
  - done on port and a route (/health is common)
  - is response is not 200 then instance is unhealthy
- some can be internal (private) or external (public)
- security groups only allow traffic if coming from load balancer
  - HTTP (80) & HTTPS (443) are open on Load Balancer
  - HTTP (80) on EC2 with source as Load Balancer Security Group

### Sticky Sessions (Session Affinity)

- same client goes to same instance behind load balancer
- classic and application load balancer
- "cookie" used for stickiness has an expiriation date you control
  - make sure user doesnt load session data
- may bring imbalance to the load
- Cookie Names
  - Application-based Cookies
    - custom cookie
      - generated by target
      - can include any custom attributes required by the application
      - cookie namemust be specified individually for each target group
      - done use AWSALB, AWSALBAPP, or AWSALBTG (reserved for use by ELB)
    - application cookie
      - generated by the load balancer
      - cookie name is always AWSALBAPP
  - Duration-based Cookies
    - cookie is generated by the load balancer
    - cookie name is AWSALB for ALB, AWSELB for CLB

### Cross Zone Load Balancing

- each load balancer instances distributes evenlty across all registered instances in all AZ
- ALB
  - always on (cant be disabled)
  - no charges for inter AZ data
- NLB
  - disabled by default
  - pay charges for inter AZ data if enabled
- CLB
  - disabled by default
  - no charges for inter AZ data if enabled

### SSL Certificates

- Basics
  - an SSL Certificate allows traffic between your clients and your load balancer to be encrypted in transit (in-flight encryption)
  - SSL refers to Secure Sockerts Layer, used to encrypt connectionsd
  - TLS referes to Transport Layer Security, which is newer version
  - Nowadays, TLS certificates are mainly used, but people still refer to SSL
  - Public SSL certificates are issues by Certificate Authorities (CA)
    - Comodo, Symantec, GoDaddy, GlobalSign, Digicert, Letsencrypt, etc
  - SSL certificates have an expiration date (you set) and must be renewed
- ELB
  - load balancer uses an X.509 certificate (SSL/TLS server certificate)
  - can manage certificates use ACM (AWS Certificate Manager)
  - can create/upload your own certificates
  - HTTPS listener:
    - must specify a default certificate
    - can add an optional list of certs to support multiple domains
    - Clients use and SNI (Server Name Indication) to specify the hostname they reach
    - ability to specify a security policy to support older versions of SSL/TLS (legacy clients)
- Server Name Indication (SNI)
  - SNI solves the problem of loading multiple SSL certificates onto one web server (to serve multiple websites)
  - "newer" protocol and requires client to indicate the hostname of the target server  in the initial SSL handshake
  - server will find the correct certificate or return the default one
  - only works of ALB & NLB (newer generation), Cloudfront
  - does not work for CLB (older generation)
- Classic Load Balancer (CLB)
  - supports only one SSL certificate
  - must use multiple CLB for multiple hostname with multiple SSL certificates
- Application Load Balancer (ALB)
  - supports listeners with multiple SSL Certificates
  - uses server name indication to make it work
- Network Load Balancer (NLB)
  - supports listeners with multiple SSL Certificates
  - uses server name indication to make it work

### Connection Draining

- Feature Naming
  - Connection Draining for CLB
  - Deregistration Delay for ALB & NLB
- time to complete "in-flight requests" while the instance is deregistering or unhealthy
- stops sending new requests to EC@ isntance which is de-registering
- between 1 to 3600 secionds (default 300 seconds)
- can be disabled (set value to 0)
- set to low value if requests are short

## Classic Load Balancer (CLB) (deprecated)

- v1 - old generation - 2009
- HTTP, HTTPS, TCS, SSL (Secure TCP)
  - TCP (Layer 4)
  - HTTP/HTTPS (Layer 7)
- health checks are TCP or HTTP based
- fixed host name
  - XXX.region.elb.amazonaws.com

## Applcation Load Balancer (ALB)

- v2 - new generation - 2016
- HTTP, HTTPS, TCS, SSL (Secure TCP)
  - HTTP/HTTPS (Layer 7)
- load balancing to multiple HTTP applications across machines (target groups)
- load balancing to multiple HTTP applications on the same machines (target groups)
- support redirects (ex: HTTP to HTTPS)
- routing tables to different target groups
  - routing based on path in URL (ex.com/users or ex.com/posts)
  - routing based on hostname in URL (one.ex.com & two.ex.com)
  - routing based on query string, headers (ex.com/users?id=123)
- great fit for microservices and container-based applications
- has port mapping features to redirect to dynamic port in ECS
- can be used in place of multiple CLBs
- fixed host name (XXX.region.elb.amazonaws.com)
- application servers dont see the IP of the client directly
  - true IP of the client is insert4ed in the header X-Forwarded-For
  - we can also get Port (X-Forwarded-Port) and prot (X-Forwarded-Proto)
- Target Groups
  - can route to multiple target groups
  - health checks are at the target group level
  - Types
    - EC2 Instances - HTTP
      - canbe managed by an Auto Scaling Group
    - ECS Tasks - HTTPS
      - managed my ECS itself
    - Lambda Functions - http request translated to JSON event
    - IP Addresses - must be private IPs

## Network Load Balancer (NLB)

- v2 - new generation - 2017
- TCP, TLS
- Layer 4
  - Forward TCP and UDP traffic to your instances
- handle millions of requests per seconds
- less latency ~100ms (vs 400ms for ALB)
- NLB has **one static IP per AZ** and supports assigning Elastic IP
  - helpful for whitlisting specific IP
- used for extreme performance for TCP/UDP traffic
- no included in free tier
- Target Groups
- health checks support TCP, HTTP, and HTTPS Protocola
  - Types
    - EC2 insances
    - Private IP Addresses
    - Application Load Balancer

## Gateway Load Balancer (GWLB)

- v2 - new generation - 2020
- operates at layer 3 (Network Layer) - IP Protocol
- deploy, scale, and manage a fleet of 3rd party network virtual appliances in AWS
- firewalls, intrusion detection, prevention systems, deep packet inspection systems, payload manipulation
- source -> GWLB -> securty virtual appliances -> GWLB -> destination
- combines the following functions
  - Transparent Network Gateway - single entry/exit for all traffic
  - Load Balancer - distributr traffic to your virtual appliances
- uses the **GENEVE protocol** on port **6081**
- Target Groups
  - EC2 Instances
  - Private IP Addresses

## ASG - Auto Scaling Groups

- load on website/app can change over time
- can create and remove servers quickly in AWS
- free (only pay for underlying EC2)
- goal
  - scale out (add EC2 instances) to match increased load
  - scale in (remove EC2 instances) to match decreased load
  - ensure we have a minimum and maximum # of EC2 instances to run
  - automatically register new instances to a load balancer
  - re-create an EC2 instance in case the previous one is terminated
- Attributes
  - Launch Template
    - contains information on how to launch EC2 within ASG
    - AMI + Instance Type
    - EC2 User Data
    - EBS Volumes
    - Security Groups
    - SSH Key Pair
    - IAM Roles for EC2 Instances
    - Network + Subnets Information
    - Load Balancer Information
  - min size
  - max size
  - initial capacity
  - scaling policies
- CloudWatch Alarms & Scaling
  - alarm monitors a metric
  - metrics (avg cpu) are computed for the overall ASG instances
  - based on alarm
    - create scale-out policies (increase)
    - create scale-in policies (decrease)

### Scaling Policies

- Dynamic Policies Types
  - Target Tracking Scaling
    - most simple, easy to set-up
    - EX: i want avg ASG CPU to stay at around 40%
  - Simple/Step Scaling
    - when CloudWatch alrarm is triggered (CPU > 70%), add 2 units
    - when CloudWatch alrarm is triggered (CPU < 70%), remove 1 units
  - Scheduled Actions
    - anticipate scaling based on known usage patterns
    - EX: increase the min capacity to 10 at 5pm on Fridays
  - Predictive Scaling
    - continuously forecast load and schedule scaling ahead
- Good Metrics to scale on
  - CPUUtilization: AVG CPU
    - utilization across instances
  - RequestCountPerTarget
    - make sure the # of requests per EC2 is stable
  - Average Network In/Out (if app is network bound)
  - Any custom metric that is pushed by CloudWatch
- Scaling Cooldowns
  - after a scaling activity happens you are entering a cooldown period
    - default 300s, 5 min
  - During cooldown the ASG will not launch/terminate additional instances
    - allow metrics to stablize
  - Advice - use ready-to-use AMI to reduce config time to service requests faster and reduce cooldown period